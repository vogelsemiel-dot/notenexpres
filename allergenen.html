<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notenexpres ‚Äì Allergenen</title>

  <style>
    :root{
      --brand:#E53D23;
      --text:#1b1b1b;
      --muted:#555;
      --shadow:0 16px 34px rgba(0,0,0,.10);
      --radius:22px;
      --side:22px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#fff; color:var(--text); min-height:100vh; }
    body::before, body::after{ content:""; position:fixed; top:0; bottom:0; width:var(--side); background:var(--brand); z-index:0; }
    body::before{ left:0; } body::after{ right:0; }

    .wrap{ position:relative; z-index:1; width:min(980px, calc(100% - (var(--side) * 2) - 24px)); margin:0 auto; padding:18px 0 46px; }
    .card{ background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.07); padding:18px 18px 22px; }

    .top{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
    .back{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px; text-decoration:none;
      color:var(--brand); background:#fff; border:2px solid rgba(229,61,35,.28);
      font-weight:800;
    }
    .back:hover{ background:#fff3ef; border-color:rgba(229,61,35,.45); }
    .logo{ height:40px; width:auto; }

    h1{ margin:10px 0 6px; font-size:clamp(26px,5.4vw,40px); }
    .sub{ margin:0 0 14px; color:var(--muted); font-size:clamp(14px,3.2vw,17px); }

    .warnbox{
      background:#fff3ef;
      border:1px solid rgba(229,61,35,.22);
      border-left:6px solid var(--brand);
      border-radius:18px;
      padding:12px 14px;
      margin: 10px 0 16px;
      color:#4a2a24;
      line-height:1.35;
    }

    .tools{ display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 16px; align-items:center; }
    .search{
      flex: 1 1 260px;
      display:flex;
      align-items:center;
      gap:10px;
      border:2px solid rgba(229,61,35,.25);
      border-radius:16px;
      padding:12px 12px;
      background:#fff;
    }
    .search input{ border:none; outline:none; width:100%; font-size:16px; }

    .chipbar{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      border:1px solid rgba(0,0,0,.10);
      border-radius:999px;
      padding:8px 10px;
      font-weight:800;
      font-size:13px;
      background:#fff;
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(229,61,35,.45);
      background:#fff3ef;
      color:#7a1d10;
    }

    .resultRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin: 0 0 8px; color:#666; font-size:12.5px; }
    .clearBtn{
      border:none;
      background:#fff3ef;
      border:1px solid rgba(229,61,35,.22);
      color:#7a1d10;
      font-weight:900;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
    }
    .clearBtn:hover{ background:#ffe7df; }

    .section{ border:1px solid rgba(0,0,0,.08); border-radius:18px; padding:14px; margin:14px 0; }
    .section h2{ margin:0 0 10px; font-size:20px; display:flex; gap:10px; align-items:center; }
    .pill{
      display:inline-block;
      font-size:12px;
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      background:#fff3ef;
      color:#7a1d10;
      border:1px solid rgba(229,61,35,.22);
    }

    .list{ display:grid; gap:10px; }
    @media (min-width: 820px){ .list{ grid-template-columns: 1fr 1fr; } }

    .item{ border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:12px 12px; background:#fff; }
    .name{ font-weight:900; }
    .meta{ font-size:13px; color:var(--muted); margin-top:4px; }
    .tags{ margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; background:#f6f6f6; border:1px solid rgba(0,0,0,.08); color:#333; font-weight:800; }
    .tag.warn{ background:#fff3ef; border-color: rgba(229,61,35,.22); color:#7a1d10; }

    .footerNote{ margin-top: 14px; font-size: 12.5px; color:#666; line-height:1.35; }

    .hidden{ display:none !important; }
    @media (max-width:360px){ :root{ --side:16px; } }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <a class="back" href="index.html">‚Üê Terug</a>
        <img class="logo" src="logo.jpg" alt="Notenexpres logo">
      </div>

      <h1>Allergenen</h1>
      <p class="sub">Zoek een product en zie direct de allergenen-status. (Demo ‚Äì etiket blijft leidend.)</p>

      <div class="tools">
        <div class="search">
          üîé <input id="searchInput" type="text" placeholder="Zoek product (bijv. cashew, cranberry, salademix)..." />
        </div>

        <div class="chipbar" id="chipbar">
          <!-- chips worden dynamisch gevuld -->
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px;">
          <label style="display:flex; gap:8px; align-items:center; font-weight:800; font-size:13px; color:#333; user-select:none;">
            <input id="toggleZonder" type="checkbox" />
            Toon ook ‚Äúzonder‚Äù
          </label>

          <select id="allergenFilter" style="padding:10px 12px; border-radius:14px; border:2px solid rgba(229,61,35,.25); font-weight:800; background:#fff; color:#333; cursor:pointer;">
            <option value="alles">Filter op allergeen‚Ä¶ (alles)</option>
          </select>
        </div>
      </div>

      <div class="resultRow">
        <div id="resultCount">‚Äî</div>
        <button class="clearBtn" id="clearBtn" type="button">Wis zoekopdracht</button>
      </div>

      <div id="sectionsRoot"></div>

      <div class="footerNote">
        <strong>Beheer-tip:</strong> pas producten aan in <code>producten.js</code>.
        <br>
        <strong>Kleuren uit Excel:</strong> groen = <b>zonder</b>, geel = <b>kan bevatten</b>, rood = <b>bevat</b>.
      </div>

    </div>
  </div>

  <script src="producten.js"></script>

  <script>
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const resultCount = document.getElementById('resultCount');
    const chipbar = document.getElementById('chipbar');

    const toggleZonder = document.getElementById('toggleZonder');
    const allergenFilter = document.getElementById('allergenFilter');

    // Extra filters
    let showZonder = false;
    // allergenFilter value format: "alles" or "bevat|Gluten" or "kan|Pinda‚Äôs" or "bevatkan|Sesam"
    let activeAllergenFilter = "alles";

    const sectionsRoot = document.getElementById('sectionsRoot');

    let activeFilter = 'alles';

    function normalize(s){
      return (s || '').toString().toLowerCase().trim()
        .normalize("NFD").replace(/\p{Diacritic}/gu, "");
    }

    function escapeHtml(str) {
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getCategorieTitel(key){
      if (typeof CATEGORIE_TITELS === "object" && CATEGORIE_TITELS[key]) return CATEGORIE_TITELS[key];
      return key;
    }

    function buildSearchHaystack(p, catKey){
      const parts = [
        p.naam,
        catKey,
        getCategorieTitel(catKey),
        ...(p.bevat || []),
        ...(p.kanBevatten || []),
        ...(p.zonder || []),
        ...(p.zieVerpakking || []),
      ];
      return normalize(parts.join(" "));
    }

    function buildChips(){
      chipbar.innerHTML = "";
      const keys = Object.keys(PRODUCTEN_PER_CATEGORIE || {});
      const allChip = document.createElement("div");
      allChip.className = "chip" + (activeFilter === "alles" ? " active" : "");
      allChip.dataset.filter = "alles";
      allChip.textContent = "Alles";
      chipbar.appendChild(allChip);

      for (const k of keys){
        const chip = document.createElement("div");
        chip.className = "chip" + (activeFilter === k ? " active" : "");
        chip.dataset.filter = k;
        chip.textContent = getCategorieTitel(k);
        chipbar.appendChild(chip);
      }

      Array.from(chipbar.querySelectorAll(".chip")).forEach(chip => {
        chip.addEventListener("click", () => {
          Array.from(chipbar.querySelectorAll(".chip")).forEach(c => c.classList.remove("active"));
          chip.classList.add("active");
          activeFilter = chip.dataset.filter;
          applyFilters();
        });
      });
    }

    
    function collectAllergens(){
      const set = new Set();
      const keys = Object.keys(PRODUCTEN_PER_CATEGORIE || {});
      for (const cat of keys){
        for (const p of (PRODUCTEN_PER_CATEGORIE[cat] || [])){
          (p.bevat || []).forEach(a => set.add(a));
          (p.kanBevatten || []).forEach(a => set.add(a));
        }
      }
      return Array.from(set).sort((a,b)=>a.localeCompare(b,"nl",{sensitivity:"base"}));
    }

    function buildAllergenDropdown(){
      const allergens = collectAllergens();
      allergenFilter.innerHTML = "";
      allergenFilter.insertAdjacentHTML("beforeend", `<option value="alles">Filter op allergeen‚Ä¶ (alles)</option>`);

      const mkOpt = (value, label) => `<option value="${value}">${label}</option>`;

      if (allergens.length){
        allergenFilter.insertAdjacentHTML("beforeend", `<optgroup label="Bevat">` + allergens.map(a => mkOpt("bevat|" + a, a)).join("") + `</optgroup>`);
        allergenFilter.insertAdjacentHTML("beforeend", `<optgroup label="Kan bevatten">` + allergens.map(a => mkOpt("kan|" + a, a)).join("") + `</optgroup>`);
        allergenFilter.insertAdjacentHTML("beforeend", `<optgroup label="Bevat of kan bevatten">` + allergens.map(a => mkOpt("bevatkan|" + a, a)).join("") + `</optgroup>`);
      }
    }


function renderAllSections(){
      sectionsRoot.innerHTML = "";
      const categorieKeys = Object.keys(PRODUCTEN_PER_CATEGORIE || {});

      for (const cat of categorieKeys){
        const producten = (PRODUCTEN_PER_CATEGORIE[cat] || []).slice()
          .sort((a,b) => (a.naam || "").localeCompare((b.naam || ""), "nl", { sensitivity:"base" }));

        const section = document.createElement("div");
        section.className = "section";
        section.setAttribute("data-category", cat);

        section.innerHTML = `
          <h2>${escapeHtml(getCategorieTitel(cat))} <span class="pill">${escapeHtml(cat)}</span></h2>
          <div class="list"></div>
        `;

        const list = section.querySelector(".list");

        for (const p of producten){
          const item = document.createElement("div");
          item.className = "item";
          item.setAttribute("data-category", cat);
          item.setAttribute("data-name", buildSearchHaystack(p, cat));
          item.setAttribute("data-bevat", normalize((p.bevat || []).join(" | ")));
          item.setAttribute("data-kan", normalize((p.kanBevatten || []).join(" | ")));
          item.setAttribute("data-bevatkan", normalize([...(p.bevat||[]), ...(p.kanBevatten||[])].join(" | ")));


          const tags = [];
          (p.bevat || []).forEach(a => tags.push(`<span class="tag warn">bevat: ${escapeHtml(a)}</span>`));
          (p.kanBevatten || []).forEach(a => tags.push(`<span class="tag">kan bevatten: ${escapeHtml(a)}</span>`));
          // "zonder" kan veel info zijn: toon alleen als showZonder aan staat,
          // of (om rustig te blijven) wanneer er g√©√©n "bevat/kan bevatten" tags zijn.
          const hasRisk = ((p.bevat || []).length + (p.kanBevatten || []).length) > 0;
          if (showZonder || !hasRisk){
            (p.zonder || []).forEach(a => tags.push(`<span class="tag">zonder: ${escapeHtml(a)}</span>`));
          }
          if ((p.zieVerpakking || []).length) {
            tags.push(`<span class="tag">check etiket</span>`);
          }

          item.innerHTML = `
            <div class="name">${escapeHtml(p.naam || "")}</div>
            <div class="meta">Categorie: ${escapeHtml(getCategorieTitel(cat))}</div>
            <div class="tags">${tags.join("") || '<span class="tag">check etiket</span>'}</div>
          `;

          list.appendChild(item);
        }

        sectionsRoot.appendChild(section);
      }
    }

    function applyFilters(){
      const q = normalize(searchInput.value);

      const af = (activeAllergenFilter || "alles");
      const [afTypeRaw, ...afRest] = af.split("|");
      const afType = afTypeRaw;
      const afValue = normalize(afRest.join("|") || "");
      const sections = Array.from(document.querySelectorAll('.section'));

      let visibleCount = 0;

      sections.forEach(section => {
        const items = Array.from(section.querySelectorAll('.item'));

        items.forEach(item => {
          const hay = normalize(item.getAttribute('data-name'));
          const cat  = item.getAttribute('data-category');

          const matchesText = !q || hay.includes(q);
          const matchesCat  = (activeFilter === 'alles') || (cat === activeFilter);
          const attrName = (afType === 'bevat' ? 'data-bevat' : afType === 'kan' ? 'data-kan' : afType === 'bevatkan' ? 'data-bevatkan' : 'data-bevatkan');
          const draagt = normalize(item.getAttribute(attrName));
          const matchesAllergen = (afType === 'alles') || !afValue || draagt.includes(afValue);

          const show = matchesText && matchesCat && matchesAllergen;
          item.classList.toggle('hidden', !show);
          if(show) visibleCount++;
        });

        const hasVisible = items.some(it => !it.classList.contains('hidden'));
        section.classList.toggle('hidden', !hasVisible);
      });

      resultCount.textContent = `${visibleCount} product(en) gevonden`;
    }

    searchInput.addEventListener('input', applyFilters);
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchInput.focus();
      applyFilters();
    });

    // init
    buildChips();
    buildAllergenDropdown();
    renderAllSections();
    applyFilters();

    toggleZonder.addEventListener("change", () => {
      showZonder = toggleZonder.checked;
      renderAllSections();
      applyFilters();
    });

    allergenFilter.addEventListener("change", () => {
      activeAllergenFilter = allergenFilter.value || "alles";
      applyFilters();
    });
  </script>
</body>
</html>
